From 9f15c15b4443b607246dc72380caf234a6cfaf63 Mon Sep 17 00:00:00 2001
From: Eike Kettner <eike.kettner@posteo.de>
Date: Sun, 1 Feb 2015 21:58:44 +0100
Subject: [PATCH] urlfix

---
 src/main/java/com/gitblit/wicket/pages/BasePage.java  | 11 ++++++++++-
 src/main/java/com/gitblit/wicket/panels/LogPanel.java |  2 +-
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/main/java/com/gitblit/wicket/pages/BasePage.java b/src/main/java/com/gitblit/wicket/pages/BasePage.java
index b696700..dbfe87e 100644
--- a/src/main/java/com/gitblit/wicket/pages/BasePage.java
+++ b/src/main/java/com/gitblit/wicket/pages/BasePage.java
@@ -110,7 +110,16 @@ public abstract class BasePage extends SessionPage {
 	protected String getCanonicalUrl(Class<? extends BasePage> clazz, PageParameters params) {
 		String relativeUrl = urlFor(clazz, params).toString();
 		String canonicalUrl = RequestUtils.toAbsolutePath(relativeUrl);
-		return canonicalUrl;
+		String requestBase = RequestUtils.toAbsolutePath(urlFor(getApplication().getHomePage(), null).toString());
+		String baseUrl = app().settings().getString(Keys.web.canonicalUrl, null);
+		if (baseUrl != null) {
+			if (!baseUrl.endsWith("/")) {
+				baseUrl = baseUrl + "/";
+			}
+			return canonicalUrl.replaceFirst(requestBase, baseUrl);
+		} else {
+			return canonicalUrl;
+		}
 	}
 
 	protected void redirectTo(Class<? extends BasePage> pageClass) {
diff --git a/src/main/java/com/gitblit/wicket/panels/LogPanel.java b/src/main/java/com/gitblit/wicket/panels/LogPanel.java
index 16fc746..a1f329b 100644
--- a/src/main/java/com/gitblit/wicket/panels/LogPanel.java
+++ b/src/main/java/com/gitblit/wicket/panels/LogPanel.java
@@ -75,7 +75,7 @@ public class LogPanel extends BasePanel {
 		// works unless commits.size() represents the exact end.
 		hasMore = commits.size() >= itemsPerPage;
 
-		final String baseUrl = WicketUtils.getGitblitURL(getRequest());
+		final String baseUrl = app().settings().getString(Keys.web.canonicalUrl, WicketUtils.getGitblitURL(getRequest()));
 		final boolean showGraph = app().settings().getBoolean(Keys.web.showBranchGraph, true);
 
 		MarkupContainer graph = new WebMarkupContainer("graph");
-- 
2.1.3

